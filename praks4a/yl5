#! /bin/bash
# See skript teeb backupi kasutaja antud kataloogist ja pakib selle kokku koos hetke kuupäevaga

expand_path() {
    eval echo "$1"
}

read -p "Sisesta kataloogi tee, mida soovid varundada: " kataloog_input
kataloog=$(expand_path "$kataloog_input")

if [ ! -d "$kataloog" ]; then
    echo "Kataloogi '$kataloog' ei eksisteeri."
    exit 1
fi

if [ ! -r "$kataloog" ]; then
    echo "Selle kausta varundamiseks on vaja rohkem õigusi."
    exit 1
fi

read -p "Sisesta kataloog, kuhu soovid backupi salvestada: " backup_input
backup_kataloog=$(expand_path "$backup_input")

if [ ! -d "$backup_kataloog" ]; then
    echo "Backup kataloogi '$backup_kataloog' ei eksisteeri."
    exit 1
fi

if [ ! -w "$backup_kataloog" ]; then
    echo "Backup kataloogi '$backup_kataloog' kirjutamise õigused puuduvad."
    exit 1
fi

katalooginimi=$(basename "$kataloog")
kuupaev=$(date +"%d%b%Y" | tr '[:upper:]' '[:lower:]')

function leia_vaba_failinimi() {
    local baasnimi="$1"
    local kataloog="$2"
    local number=1
    local failinimi="$baasnimi.backup.$kuupaev.tar.gz"

    if [ ! -e "$kataloog/$failinimi" ]; then
        echo "$failinimi"
        return
    fi

    while [ -e "$kataloog/$baasnimi.backup.$kuupaev.$number.tar.gz" ]; do
        number=$((number + 1))
    done

    echo "$baasnimi.backup.$kuupaev.$number.tar.gz"
}

failinimi=$(leia_vaba_failinimi "$katalooginimi" "$backup_kataloog")

if [ -e "$backup_kataloog/$katalooginimi.backup.$kuupaev.tar.gz" ]; then
    read -p "Backup fail '$katalooginimi.backup.$kuupaev.tar.gz' juba olemas. Kas soovid luua uue varukoopia versiooni? (jah/ei): " vastus
    if [[ "$vastus" =~ ^(jah)$ ]]; then
        failinimi=$(leia_vaba_failinimi "$katalooginimi" "$backup_kataloog")
    else
        echo "Varundamine katkestatud."
        exit 0
    fi
fi

if tar -czf "$backup_kataloog/$failinimi" -C "$(dirname "$kataloog")" "$katalooginimi" 2>/dev/null; then
    echo "Varundamine lõpetatud. Fail salvestatud: $backup_kataloog/$failinimi"
else
    echo "Varundamine ebaõnnestus. Võimalik, et sul puuduvad vajalikud õigused kõikide failide lugemiseks."
    [ -f "$backup_kataloog/$failinimi" ] && rm -f "$backup_kataloog/$failinimi"
    exit 1
fi
